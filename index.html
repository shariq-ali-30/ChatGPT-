<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>QuizMaster — Advanced Quiz App</title>
<meta name="description" content="Advanced Quiz App (single file) with categories, timer, lifelines, leaderboard" />
<style>
  /* ============================
     QuizMaster Styles
     ============================ */
  :root{
    --bg: #0b1020;
    --card: rgba(255,255,255,0.03);
    --muted: rgba(255,255,255,0.72);
    --accent: #60a5fa;
    --accent-2: #7c3aed;
    --success: #10b981;
    --danger: #fb7185;
    --glass: rgba(255,255,255,0.02);
    --radius: 12px;
    --max-w: 1100px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
  }

  *{box-sizing:border-box}
  html,body,#app{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.12), transparent 10%),
                radial-gradient(900px 400px at 90% 90%, rgba(96,165,250,0.09), transparent 8%),
                var(--bg);
    color:#e9f0ff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .app{
    width:100%;
    max-width:var(--max-w);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    padding:18px;
    box-shadow: 0 10px 40px rgba(2,6,23,0.7);
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:18px;
  }

  /* Sidebar */
  .sidebar{
    padding:16px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    min-height:520px;
  }
  .brand{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:grid;place-items:center;font-weight:800;color:#031; font-size:18px}
  h1{font-size:18px;margin:0}
  .lead{font-size:13px;color:var(--muted);margin-top:4px}

  .section{margin-top:12px}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  select,input[type="number"],textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    background:transparent;color:inherit;outline:none;font-size:14px;
  }
  .btn{display:inline-flex;gap:8px;align-items:center;background:var(--accent);color:#012;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
  .small{font-size:13px;padding:6px 10px;border-radius:8px}

  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}

  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .help{font-size:12px;color:var(--muted);margin-top:8px}

  /* Main area */
  .main{
    padding:16px;border-radius:12px;min-height:520px;position:relative;
  }

  .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .meta{display:flex;gap:12px;align-items:center}
  .progress{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;width:320px}
  .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%}

  .question-card{margin-top:14px;background:var(--card);border-radius:12px;padding:16px;min-height:250px;display:flex;flex-direction:column;gap:12px}
  .q-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .q-text{font-size:20px;font-weight:700}
  .q-sub{font-size:13px;color:var(--muted)}

  .answers{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
  .answer{
    padding:12px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02);
    transition:all .18s;display:flex;align-items:center;gap:10px;font-size:15px;
  }
  .answer:hover{transform:translateY(-4px);box-shadow:0 8px 18px rgba(2,6,23,0.45)}
  .answer.selected{border-color:var(--accent);box-shadow:0 8px 20px rgba(96,165,250,0.06)}
  .answer.correct{background:linear-gradient(90deg, rgba(16,185,129,0.12), rgba(16,185,129,0.04));border-color:rgba(16,185,129,0.4)}
  .answer.wrong{background:linear-gradient(90deg, rgba(251,113,133,0.06), rgba(251,113,133,0.03));border-color:rgba(251,113,133,0.3)}

  .actions{display:flex;gap:8px;align-items:center;margin-top:12px}
  .nav{display:flex;gap:8px;margin-left:auto}
  .kbd{font-family:var(--mono);background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:6px;font-size:13px;color:var(--muted)}

  .lifelines{display:flex;gap:8px}
  .lifeline{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}

  .timer{font-weight:700;font-size:16px}

  /* Review / results */
  .results{display:grid;grid-template-columns:1fr 320px;gap:12px}
  .result-card{background:var(--card);padding:12px;border-radius:10px}
  .leaderboard{margin-top:12px}
  .leader-row{display:flex;justify-content:space-between;gap:8px;padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02)}
  .small-muted{font-size:12px;color:var(--muted)}

  /* Import area */
  textarea{min-height:120px;resize:vertical}

  /* Responsive */
  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding:12px}
    .progress{width:180px}
    .answers{grid-template-columns:1fr}
    .results{grid-template-columns:1fr}
  }

</style>
</head>
<body>
  <div id="app" class="app" role="application" aria-label="QuizMaster advanced quiz app">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Quiz controls">
      <div class="brand">
        <div class="logo" aria-hidden="true">Q</div>
        <div>
          <h1>QuizMaster</h1>
          <div class="lead">Advanced quiz engine — timer, lifelines, leaderboard.</div>
        </div>
      </div>

      <div class="section">
        <label for="categorySelect">Category</label>
        <select id="categorySelect" aria-label="Select category"></select>
      </div>

      <div class="section">
        <label for="difficultySelect">Difficulty</label>
        <select id="difficultySelect" aria-label="Select difficulty">
          <option value="any">Any</option>
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>

      <div class="section">
        <label for="qcount">Number of Questions</label>
        <input id="qcount" type="number" min="5" max="50" value="10" />
      </div>

      <div class="section">
        <label>Options</label>
        <div class="controls">
          <button id="startBtn" class="btn">Start Quiz</button>
          <button id="resetBtn" class="btn secondary small">Reset</button>
        </div>
        <div class="help">Use keyboard: <span class="kbd">1</span>-<span class="kbd">4</span> to pick answer, <span class="kbd">N</span> next, <span class="kbd">P</span> prev.</div>
      </div>

      <div class="section">
        <label>Import / Create Quiz (JSON)</label>
        <textarea id="importArea" placeholder='Paste JSON array: [{"question":"..","choices":["a","b","c","d"],"answer":0,"category":"General","difficulty":"easy"}]'></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="importBtn" class="btn small">Import</button>
          <button id="clearImported" class="btn secondary small">Clear</button>
        </div>
        <div class="help">Imported quizzes are stored locally and available in Category dropdown.</div>
      </div>

      <div class="section">
        <label>Saved Leaderboard</label>
        <div id="leaderboardSidebar" class="card" style="padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);max-height:160px;overflow:auto"></div>
      </div>

      <div class="section">
        <label>About</label>
        <div class="muted">This demo stores data in your browser only (localStorage). No server required.</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main" id="mainArea">
      <div class="topbar">
        <div class="meta">
          <div class="chip" id="catChip">Category: —</div>
          <div class="chip" id="diffChip">Difficulty: —</div>
        </div>

        <div style="display:flex;align-items:center;gap:12px">
          <div class="progress" aria-hidden="true"><i id="progBar" style="width:0%"></i></div>
          <div class="timer" id="overallTimer">00:00</div>
        </div>
      </div>

      <!-- Question card -->
      <div class="question-card" id="questionCard" aria-live="polite">
        <div class="q-header">
          <div>
            <div class="q-sub" id="qIndex">Question —</div>
            <div class="q-text" id="qText">Press Start to begin the quiz</div>
          </div>
          <div style="text-align:right">
            <div class="muted" id="scoreDisplay">Score: 0</div>
            <div class="muted small-muted" id="timerNote">Per-question timer: <span id="perTimer">--</span></div>
          </div>
        </div>

        <div class="answers" id="answers" role="list">
          <!-- answer buttons inserted here -->
        </div>

        <div class="actions">
          <div class="lifelines" id="lifelines">
            <div class="lifeline" id="fiftyBtn" title="50-50 (removes two wrong answers)">50-50 (<span id="fiftyCount">2</span>)</div>
            <div class="lifeline" id="skipBtn" title="Skip current question">Skip (<span id="skipCount">1</span>)</div>
          </div>

          <div class="nav">
            <button id="prevBtn" class="btn secondary small">Prev</button>
            <button id="nextBtn" class="btn small">Next</button>
            <button id="submitBtn" class="btn" style="display:none">Submit Quiz</button>
          </div>
        </div>

        <div id="hintArea" class="muted small-muted" style="margin-top:6px">Tip: Use lifelines wisely.</div>
      </div>

      <!-- Results area (hidden until finished) -->
      <div id="resultsArea" style="display:none;margin-top:14px">
        <div class="results">
          <div>
            <div class="result-card">
              <h3 id="finalScore">You scored —</h3>
              <div class="muted small-muted" id="scoreBreakdown">—</div>
              <div style="margin-top:12px">
                <button id="retakeBtn" class="btn small">Retake</button>
                <button id="newBtn" class="btn secondary small">New Quiz</button>
                <button id="saveScoreBtn" class="btn" style="margin-left:6px">Save Score</button>
              </div>
            </div>

            <div class="result-card" style="margin-top:12px">
              <strong>Review</strong>
              <div id="reviewList" style="margin-top:8px;max-height:320px;overflow:auto"></div>
            </div>
          </div>

          <aside>
            <div class="result-card">
              <strong>Leaderboard</strong>
              <div id="leaderboard" class="leaderboard" style="margin-top:8px"></div>
            </div>

            <div class="result-card" style="margin-top:12px">
              <strong>Session Info</strong>
              <div class="small-muted" style="margin-top:8px" id="sessionInfo"></div>
            </div>
          </aside>
        </div>
      </div>

    </main>
  </div>

<script>
/*
  QuizMaster — Advanced Quiz App
  - Single file, client-side only
  - Data stored in localStorage under keys:
    - qm_quizzes  (imported/custom quizzes by category)
    - qm_leaderboard (array of {name,score,category,difficulty,date})
  - Core flow:
    1) choose category/difficulty/count -> Start
    2) questions selected -> per-question timer + overall timer
    3) lifelines: 50-50 (remove two wrong), Skip (skip question)
    4) finish -> review + save score
*/

/* =========================
   App Data (sample questions)
   ========================= */

const SAMPLE_QUIZZES = {
  "General Knowledge": [
    { question: "What is the capital of France?", choices: ["Paris","Lyon","Marseille","Nice"], answer: 0, difficulty: "easy" },
    { question: "Which planet is known as the Red Planet?", choices: ["Venus","Saturn","Mars","Mercury"], answer: 2, difficulty: "easy" },
    { question: "Who wrote '1984'?", choices: ["Aldous Huxley","George Orwell","Ray Bradbury","Ernest Hemingway"], answer: 1, difficulty: "medium" },
    { question: "Which element has the chemical symbol 'Fe'?", choices: ["Fluorine","Iron","Fermium","Francium"], answer: 1, difficulty: "easy" },
    { question: "Which country hosted the 2016 Summer Olympics?", choices: ["China","Brazil","UK","Russia"], answer: 1, difficulty: "easy" },
    { question: "What is the hardest natural substance on Earth?", choices: ["Diamond","Gold","Quartz","Graphite"], answer: 0, difficulty: "medium" }
  ],
  "Science & Nature": [
    { question: "What gas do plants absorb from the atmosphere?", choices: ["Oxygen","Nitrogen","Carbon Dioxide","Hydrogen"], answer: 2, difficulty: "easy" },
    { question: "Which organelle is the powerhouse of the cell?", choices: ["Nucleus","Mitochondria","Ribosome","Golgi apparatus"], answer: 1, difficulty: "easy" },
    { question: "What force keeps planets in orbit around the sun?", choices: ["Electromagnetism","Gravity","Friction","Tension"], answer: 1, difficulty: "easy" },
    { question: "pH value less than 7 indicates?", choices: ["Neutral","Basic","Acidic","Alkaline"], answer: 2, difficulty: "easy" }
  ],
  "History": [
    { question: "Who was the first President of the United States?", choices: ["John Adams","George Washington","Thomas Jefferson","James Madison"], answer: 1, difficulty: "easy" },
    { question: "In which year did World War II end?", choices: ["1945","1942","1939","1950"], answer: 0, difficulty: "easy" },
    { question: "The Renaissance began in which country?", choices: ["France","Spain","Italy","Germany"], answer: 2, difficulty: "medium" }
  ]
};

// Local storage keys
const LS_QUIZZES = 'qm_quizzes';
const LS_LEADER = 'qm_leaderboard';

/* =========================
   App State
   ========================= */
const STATE = {
  pool: [],           // selected questions for current quiz
  index: 0,
  answers: [],        // user's selected choice index or null
  score: 0,
  perQuestionTime: 20, // seconds per question
  perTimerInterval: null,
  overallTimerInterval: null,
  overallSeconds: 0,
  lifelines: { fifty: 2, skip: 1 },
  started: false,
  category: null,
  difficulty: null,
  qcount: 10,
  importedQuizzes: {}, // from localStorage
  leaderboard: []      // from localStorage
};
/* =========================
   DOM refs
   ========================= */
const categorySelect = document.getElementById('categorySelect');
const difficultySelect = document.getElementById('difficultySelect');
const qcountInput = document.getElementById('qcount');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const importArea = document.getElementById('importArea');
const importBtn = document.getElementById('importBtn');
const clearImported = document.getElementById('clearImported');

const catChip = document.getElementById('catChip');
const diffChip = document.getElementById('diffChip');
const progBar = document.getElementById('progBar');
const overallTimer = document.getElementById('overallTimer');

const qIndex = document.getElementById('qIndex');
const qText = document.getElementById('qText');
const answersEl = document.getElementById('answers');
const scoreDisplay = document.getElementById('scoreDisplay');
const perTimer = document.getElementById('perTimer');

const fiftyBtn = document.getElementById('fiftyBtn');
const skipBtn = document.getElementById('skipBtn');
const fiftyCount = document.getElementById('fiftyCount');
const skipCount = document.getElementById('skipCount');

const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');

const resultsArea = document.getElementById('resultsArea');
const finalScore = document.getElementById('finalScore');
const scoreBreakdown = document.getElementById('scoreBreakdown');
const reviewList = document.getElementById('reviewList');
const leaderboardEl = document.getElementById('leaderboard');
const leaderboardSidebar = document.getElementById('leaderboardSidebar');
const saveScoreBtn = document.getElementById('saveScoreBtn');
const retakeBtn = document.getElementById('retakeBtn');
const newBtn = document.getElementById('newBtn');
const sessionInfo = document.getElementById('sessionInfo');

/* =========================
   Initialization
   ========================= */
function initApp(){
  // load imported quizzes & leaderboard from localStorage
  try{
    const raw = localStorage.getItem(LS_QUIZZES);
    STATE.importedQuizzes = raw ? JSON.parse(raw) : {};
  }catch(e){ STATE.importedQuizzes = {}; }

  try{
    const rawL = localStorage.getItem(LS_LEADER);
    STATE.leaderboard = rawL ? JSON.parse(rawL) : [];
  }catch(e){ STATE.leaderboard = []; }

  // Build category list from sample + imported
  rebuildCategoryList();

  // wire events
  attachEvents();

  // UI initial states
  updateLifelineUI();
  refreshLeaderboardUI();
}
initApp();

/* =========================
   Build category select
   ========================= */
function rebuildCategoryList(){
  // categories: combine SAMPLE_QUIZZES keys and imported names
  const categories = new Set(Object.keys(SAMPLE_QUIZZES));
  for(const k in STATE.importedQuizzes) categories.add(k);
  // clear and populate
  categorySelect.innerHTML = '';
  const anyOpt = document.createElement('option');
  anyOpt.value = 'any';
  anyOpt.textContent = 'Any Category';
  categorySelect.appendChild(anyOpt);
  categories.forEach(cat=>{
    const opt = document.createElement('option');
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
}

/* =========================
   Event wiring
   ========================= */
function attachEvents(){
  startBtn.addEventListener('click', startQuiz);
  resetBtn.addEventListener('click', resetApp);
  importBtn.addEventListener('click', importQuizzes);
  clearImported.addEventListener('click', clearImportedQuizzes);
  prevBtn.addEventListener('click', prevQuestion);
  nextBtn.addEventListener('click', nextQuestion);
  fiftyBtn.addEventListener('click', useFifty);
  skipBtn.addEventListener('click', useSkip);
  submitBtn.addEventListener('click', finishQuiz);
  saveScoreBtn.addEventListener('click', saveScore);
  retakeBtn.addEventListener('click', retakeQuiz);
  newBtn.addEventListener('click', startNewQuiz);

  // keyboard shortcuts for answers & nav
  document.addEventListener('keydown', (e)=>{
    if(!STATE.started) return;
    if(['1','2','3','4'].includes(e.key)){
      const idx = Number(e.key) - 1;
      selectAnswer(idx);
    } else if(e.key.toLowerCase() === 'n'){
      nextQuestion();
    } else if(e.key.toLowerCase() === 'p'){
      prevQuestion();
    } else if(e.key === ' '){
      e.preventDefault();
      // space to toggle pause? (not implemented) — we could use it for next
      nextQuestion();
    }
  });
}

/* =========================
   Core: Start Quiz
   ========================= */
function startQuiz(){
  // read options
  const cat = categorySelect.value;
  const diff = difficultySelect.value;
  const qcount = parseInt(qcountInput.value) || 10;

  STATE.category = cat === 'any' ? null : cat;
  STATE.difficulty = diff === 'any' ? null : diff;
  STATE.qcount = Math.min(Math.max(qcount, 5), 50);

  // build question pool
  let pool = [];

  // gather from sample
  for(const k in SAMPLE_QUIZZES){
    // category filtering
    if(STATE.category && k !== STATE.category) continue;
    SAMPLE_QUIZZES[k].forEach(q=>{
      if(STATE.difficulty && q.difficulty !== STATE.difficulty) return;
      pool.push({...q, category: k});
    });
  }

  // gather from imported quizzes
  for(const k in STATE.importedQuizzes){
    if(STATE.category && k !== STATE.category) continue;
    const arr = STATE.importedQuizzes[k] || [];
    arr.forEach(q=>{
      if(STATE.difficulty && q.difficulty !== STATE.difficulty) return;
      pool.push({...q, category: k});
    });
  }
  if(pool.length === 0){
    alert('No questions match your selection. Try different category/difficulty or import questions.');
    return;
  }

  // shuffle pool and pick qcount
  pool = shuffleArray(pool);
  pool = pool.slice(0, STATE.qcount);

  // init state
  STATE.pool = pool;
  STATE.index = 0;
  STATE.answers = new Array(pool.length).fill(null);
  STATE.score = 0;
  STATE.perQuestionTime = 20; // could make configurable
  STATE.lifelines = { fifty: 2, skip: 1 };
  STATE.started = true;
  STATE.overallSeconds = 0;

  // UI update
  catChip.textContent = `Category: ${STATE.category || 'Any'}`;
  diffChip.textContent = `Difficulty: ${STATE.difficulty || 'Any'}`;
  scoreDisplay.textContent = `Score: ${STATE.score}`;
  fiftyCount.textContent = STATE.lifelines.fifty;
  skipCount.textContent = STATE.lifelines.skip;
  updateLifelineUI();
  renderQuestion();
  startTimers();
  document.getElementById('resultsArea').style.display = 'none';
  document.getElementById('questionCard').scrollIntoView({behavior:'smooth'});
}

/* =========================
   Timers
   ========================= */
function startTimers(){
  stopTimers();
  // per-question timer
  let remaining = STATE.perQuestionTime;
  perTimer.textContent = formatTime(remaining);
  STATE.perTimerInterval = setInterval(()=>{
    remaining--;
    perTimer.textContent = formatTime(remaining);
    if(remaining <= 0){
      clearInterval(STATE.perTimerInterval);
      // auto move next and mark unanswered as null
      // no penalty except missing opportunity
      autoAdvanceAfterTimeout();
    }
  }, 1000);

  // overall timer
  STATE.overallTimerInterval = setInterval(()=>{
    STATE.overallSeconds++;
    overallTimer.textContent = formatTime(STATE.overallSeconds);
  }, 1000);
}

function stopTimers(){
  if(STATE.perTimerInterval) { clearInterval(STATE.perTimerInterval); STATE.perTimerInterval = null; }
  if(STATE.overallTimerInterval){ clearInterval(STATE.overallTimerInterval); STATE.overallTimerInterval = null; }
}

function restartPerTimer(){
  if(STATE.perTimerInterval) clearInterval(STATE.perTimerInterval);
  let remaining = STATE.perQuestionTime;
  perTimer.textContent = formatTime(remaining);
  STATE.perTimerInterval = setInterval(()=>{
    remaining--;
    perTimer.textContent = formatTime(remaining);
    if(remaining <= 0){
      clearInterval(STATE.perTimerInterval);
      autoAdvanceAfterTimeout();
    }
  }, 1000);
}

/* on timeout: treat unanswered then move next */
function autoAdvanceAfterTimeout(){
  // leave answer as null, move next
  nextQuestion();
}

/* =========================
   Render question & answers
   ========================= */
function renderQuestion(){
  const i = STATE.index;
  const qObj = STATE.pool[i];
  qIndex.textContent = `Question ${i+1} of ${STATE.pool.length}`;
  qText.textContent = qObj.question;
  scoreDisplay.textContent = `Score: ${STATE.score}`;

  // progress
  const pct = Math.round(((i) / STATE.pool.length) * 100);
  progBar.style.width = pct + '%';

  // render answers
  answersEl.innerHTML = '';
  qObj.choices.forEach((ch, idx)=>{
    const a = document.createElement('button');
    a.className = 'answer';
    a.setAttribute('role','button');
    a.dataset.index = idx;
    a.tabIndex = 0;
    a.innerHTML = `<span style="font-weight:700">${String.fromCharCode(65+idx)}</span><div style="flex:1;text-align:left">${escapeHtml(ch)}</div>`;
    // mark if previously selected
    if(STATE.answers[i] === idx) a.classList.add('selected');
    a.addEventListener('click', ()=> selectAnswer(idx));
    answersEl.appendChild(a);
  });

  // hide submit btn until last question
  submitBtn.style.display = (i === STATE.pool.length - 1) ? 'inline-flex' : 'none';

  // reset per-question timer
  restartPerTimer();

  // expose hint for keyboard
  document.getElementById('hintArea').textContent = 'Use keys 1-4 to pick an answer.';

  // clear any 50-50 marks (we'll manage removed choices)
  // focus first answer for accessibility
  const firstBtn = answersEl.querySelector('.answer');
  if(firstBtn) firstBtn.focus();
}

/* =========================
   Select answer
   ========================= */
function selectAnswer(choiceIdx){
  if(!STATE.started) return;
  const i = STATE.index;
  const qObj = STATE.pool[i];
  // if already answered and we want to allow change? allow change before moving on
  STATE.answers[i] = choiceIdx;

  // mark UI selected and show immediate correctness (optionally)
  // We'll reveal correctness only when user hits Next or at finish. But highlight selection.
  Array.from(answersEl.children).forEach(btn=>{
    btn.classList.remove('selected');
  });
  const btn = answersEl.querySelector(`button.answer[data-index="${choiceIdx}"]`);
  if(btn) btn.classList.add('selected');

  // small UX: auto move next after 700ms so user sees selection
  setTimeout(()=> {
    // update score incrementally
    // we won't finalize correctness until finish, but we can give instant feedback:
    const correct = qObj.answer === choiceIdx;
    if(correct){
      // give small score reward
      STATE.score += 1;
    }
    // move next if not last question
    if(STATE.index < STATE.pool.length - 1){
      nextQuestion();
    } else {
      // if last question, show submit button
      submitBtn.style.display = 'inline-flex';
    }
    // update score display
    scoreDisplay.textContent = `Score: ${STATE.score}`;
  }, 600);
}

/* =========================
   Navigation
   ========================= */
function nextQuestion(){
  if(!STATE.started) return;
  // stop any per timer and reset for next
  // allow moving even if at end -> finish
  if(STATE.index < STATE.pool.length - 1){
    STATE.index++;
    // restart per-question timer
    renderQuestion();
  } else {
    // last -> finish
    finishQuiz();
  }
}

function prevQuestion(){
  if(!STATE.started) return;
  if(STATE.index > 0){
    STATE.index--;
    renderQuestion();
  }
}

/* =========================
   Lifelines
   ========================= */
function updateLifelineUI(){
  fiftyCount.textContent = STATE.lifelines.fifty;
  skipCount.textContent = STATE.lifelines.skip;
  fiftyBtn.classList.toggle('disabled', STATE.lifelines.fifty <= 0);
  skipBtn.classList.toggle('disabled', STATE.lifelines.skip <= 0);
}

function useFifty(){
  if(!STATE.started) return;
  if(STATE.lifelines.fifty <= 0) return alert('No 50-50 lifelines left.');
  // remove two wrong choices from current question (hide buttons)
  const i = STATE.index;
  const q = STATE.pool[i];
  if(q.choices.length <= 2) return alert('Not enough choices to remove.');
  // compute wrong indices
  const wrongs = q.choices.map((_, idx) => idx).filter(idx => idx !== q.answer);
  shuffleArray(wrongs);
  const toRemove = wrongs.slice(0, Math.max(1, wrongs.length - 1)); // remove until 2 remain (1 correct + 1 wrong)
  // hide these buttons
  toRemove.forEach(idx=>{
    const btn = answersEl.querySelector(`button.answer[data-index="${idx}"]`);
    if(btn){ btn.style.visibility = 'hidden'; btn.disabled = true; }
  });
  STATE.lifelines.fifty--;
  updateLifelineUI();
}

function useSkip(){
  if(!STATE.started) return;
  if(STATE.lifelines.skip <= 0) return alert('No skip lifelines left.');
  // Mark current as skipped (store as null but move on)
  STATE.answers[STATE.index] = null; // explicit skip
  STATE.lifelines.skip--;
  updateLifelineUI();
  nextQuestion();
}

/* =========================
   Finish & Review
   ========================= */
function finishQuiz(){
  if(!STATE.started) return;
  stopTimers();
  STATE.started = false;

  // compute final score accurately (in case instant scoring gave same)
  let correctCount = 0;
  for(let i=0;i<STATE.pool.length;i++){
    const q = STATE.pool[i];
    if(STATE.answers[i] === q.answer) correctCount++;
  }
  STATE.score = correctCount;

  // show results area
  document.getElementById('resultsArea').style.display = 'block';
  finalScore.textContent = `You scored ${STATE.score} / ${STATE.pool.length}`;
  scoreBreakdown.textContent = `Correct: ${STATE.score} • Questions: ${STATE.pool.length} • Time: ${formatTime(STATE.overallSeconds)}`;

  // review list
  reviewList.innerHTML = '';
  STATE.pool.forEach((q, idx)=>{
    const user = STATE.answers[idx];
    const row = document.createElement('div');
    row.style.padding = '8px';
    row.style.borderBottom = '1px dashed rgba(255,255,255,0.03)';
    row.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="max-width:70%">
          <div style="font-weight:700">${escapeHtml(q.question)}</div>
          <div class="muted small-muted">${escapeHtml(q.choices.map((c,i)=> `${String.fromCharCode(65+i)}. ${c}`).join(' | '))}</div>
        </div>
        <div style="text-align:right">
          <div>${user === q.answer ? '<span style="color:var(--success)">Correct</span>' : `<span style="color:var(--danger)">Wrong</span>`}</div>
          <div class="muted" style="font-size:12px">Answer: ${String.fromCharCode(65+q.answer)}</div>
        </div>
      </div>
    `;
    reviewList.appendChild(row);
  });

  // show leaderboard and session info
  refreshLeaderboardUI();
  sessionInfo.innerHTML = `
    Category: ${STATE.category || 'Any'}<br/>
    Difficulty: ${STATE.difficulty || 'Any'}<br/>
    Questions: ${STATE.pool.length}<br/>
    Time: ${formatTime(STATE.overallSeconds)}
  `;

  // scroll to results
  document.getElementById('resultsArea').scrollIntoView({behavior:'smooth'});
}

/* =========================
   Leaderboard (local)
   ========================= */
function saveScore(){
  const name = prompt('Enter name for leaderboard (max 20 chars):','Player');
  if(!name) return;
  const entry = {
    name: name.slice(0,20),
    score: STATE.score,
    total: STATE.pool.length,
    category: STATE.category || 'Any',
    difficulty: STATE.difficulty || 'Any',
    date: new Date().toISOString()
  };
  STATE.leaderboard.push(entry);
  // sort by score desc then time asc (shorter time better)
  STATE.leaderboard.sort((a,b) => {
    if(b.score !== a.score) return b.score - a.score;
    return (new Date(a.date) - new Date(b.date));
  });
  // keep top 50
  STATE.leaderboard = STATE.leaderboard.slice(0,50);
  localStorage.setItem(LS_LEADER, JSON.stringify(STATE.leaderboard));
  refreshLeaderboardUI();
  alert('Saved to leaderboard!');
}
function refreshLeaderboardUI(){
  leaderboardEl.innerHTML = '';
  leaderboardSidebar.innerHTML = '';
  const list = STATE.leaderboard || [];
  if(list.length === 0){
    leaderboardEl.innerHTML = '<div class="muted small-muted">No scores yet.</div>';
    leaderboardSidebar.innerHTML = '<div class="muted small-muted">No scores yet.</div>';
    return;
  }
  list.slice(0,10).forEach((entry, idx)=>{
    const row = document.createElement('div');
    row.className = 'leader-row';
    row.innerHTML = `<div>${idx+1}. <strong>${escapeHtml(entry.name)}</strong></div><div>${entry.score}/${entry.total}</div>`;
    leaderboardEl.appendChild(row);
  });
  // sidebar compact
  STATE.leaderboard.slice(0,6).forEach((e, i)=>{
    const r = document.createElement('div');
    r.style.padding = '6px 0';
    r.innerHTML = `${i+1}. <strong>${escapeHtml(e.name)}</strong> <span class="muted">(${e.score}/${e.total})</span>`;
    leaderboardSidebar.appendChild(r);
  });
}

/* =========================
   Retake / New
   ========================= */
function retakeQuiz(){
  // reset scores and timers but use same pool
  STATE.index = 0;
  STATE.answers = new Array(STATE.pool.length).fill(null);
  STATE.score = 0;
  STATE.started = true;
  STATE.overallSeconds = 0;
  updateLifelineUI();
  renderQuestion();
  startTimers();
  document.getElementById('resultsArea').style.display = 'none';
}

function startNewQuiz(){
  // go back to UI for selections
  document.getElementById('resultsArea').style.display = 'none';
  STATE.started = false;
  stopTimers();
  // clear state
  STATE.pool = [];
  STATE.answers = [];
  STATE.score = 0;
  STATE.index = 0;
  progBar.style.width = '0%';
  overallTimer.textContent = '00:00';
  perTimer.textContent = '--';
  document.getElementById('questionCard').querySelector('#qText').textContent = 'Press Start to begin the quiz';
}

/* =========================
   Import / Clear imported quizzes
   ========================= */
function importQuizzes(){
  const raw = importArea.value.trim();
  if(!raw) return alert('Paste JSON array into the textarea first.');
  let arr;
  try{
    arr = JSON.parse(raw);
    if(!Array.isArray(arr)) throw new Error('JSON must be an array');
  } catch(e){
    return alert('Invalid JSON: ' + (e.message || e));
  }
  // require each item to have question, choices, answer
  for(const item of arr){
    if(!item.question || !Array.isArray(item.choices) || typeof item.answer !== 'number'){
      return alert('Each item must include "question" (string), "choices" (array), "answer" (index number).');
    }
  }
  // ask for category name
  const cat = prompt('Enter category name for imported questions (e.g., "User Imports")','Imported') || 'Imported';
  if(!STATE.importedQuizzes[cat]) STATE.importedQuizzes[cat] = [];
  // normalize and push
  arr.forEach(i=>{
    STATE.importedQuizzes[cat].push({
      question: i.question,
      choices: i.choices,
      answer: i.answer,
      difficulty: i.difficulty || 'any'
    });
  });
  // save
  localStorage.setItem(LS_QUIZZES, JSON.stringify(STATE.importedQuizzes));
  importArea.value = '';
  rebuildCategoryList();
  alert(`Imported ${arr.length} questions into category "${cat}".`);
}

function clearImportedQuizzes(){
  if(!confirm('Clear all imported quizzes from local storage?')) return;
  STATE.importedQuizzes = {};
  localStorage.removeItem(LS_QUIZZES);
  rebuildCategoryList();
  alert('Imported quizzes cleared.');
}

/* =========================
   Reset App
   ========================= */
function resetApp(){
  if(!confirm('Reset app state? This will clear imported quizzes & leaderboard.')) return;
  localStorage.removeItem(LS_QUIZZES);
  localStorage.removeItem(LS_LEADER);
  STATE.importedQuizzes = {};
  STATE.leaderboard = [];
  rebuildCategoryList();
  refreshLeaderboardUI();
  alert('App reset.');
}

/* =========================
   Utility functions
   ========================= */
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function formatTime(sec){
  if(sec < 0) sec = 0;
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function escapeHtml(s){
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* =========================
   Misc utilities for pressure-free demo
   ========================= */
/* We reveal correct/wrong when reviewing; also allow clearing leaderboard via console if needed */
window.QM = {
  STATE,
  SAMPLE_QUIZZES,
  LS_QUIZZES,
  LS_LEADER
};

/* =========================
   Small polish: update lifeline UI on load
   ========================= */
updateLifelineUI();

</script>
</body>
</html>